# ensure code is compiled once, before parallelizing
echo Compiling and running standard tests...
results=target/debug/qc-results
rm -rf $results
mkdir -p $results
OPS=$(cargo test -- --list 2> /dev/null | head -n -3 | rev | cut -c 7- | rev)
cargo test --no-run
if [ ${PIPESTATUS[0]} -eq 0 ]; then
TESTPATTERN="../target/debug/deps"
unset -v TESTEXE
for file in "$TESTPATTERN"/*.exe; do
  [[ $file -nt $TESTEXE ]] && TESTEXE=$file
done
RUST_BACKTRACE=1 time parallel "$TESTEXE {} > $results/{}.log; if [ \$? -eq 0 ]; then rm $results/{}.log; fi" ::: $OPS
fi